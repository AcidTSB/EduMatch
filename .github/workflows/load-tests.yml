name: Load Testing

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL to test (e.g., https://auth-service-app.azurecontainerapps.io)'
        required: true
        default: 'http://localhost:8081'
      duration:
        description: 'Test duration (e.g., 5m, 10m, 1h)'
        required: true
        default: '5m'
      vus:
        description: 'Number of virtual users'
        required: true
        default: '50'
      scenario:
        description: 'Test scenario'
        required: true
        type: choice
        options:
          - smoke-test
          - load-test
          - stress-test
          - spike-test
          - soak-test

jobs:
  # ============================================================
  # Job 1: Load Test with k6
  # ============================================================
  k6-load-test:
    name: k6 Load Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Run k6 load test
        run: |
          k6 run tests/load/k6-script.js \
            --env TARGET_URL=${{ github.event.inputs.target_url }} \
            --env DURATION=${{ github.event.inputs.duration }} \
            --env VUS=${{ github.event.inputs.vus }} \
            --env SCENARIO=${{ github.event.inputs.scenario }} \
            --out json=reports/k6-results.json

      - name: Upload k6 results
        uses: actions/upload-artifact@v3
        with:
          name: k6-load-test-results
          path: reports/

      - name: Generate summary
        run: |
          echo "# Load Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target URL:** ${{ github.event.inputs.target_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Duration:** ${{ github.event.inputs.duration }}" >> $GITHUB_STEP_SUMMARY
          echo "**Virtual Users:** ${{ github.event.inputs.vus }}" >> $GITHUB_STEP_SUMMARY
          echo "**Scenario:** ${{ github.event.inputs.scenario }}" >> $GITHUB_STEP_SUMMARY

  # ============================================================
  # Job 2: Azure Load Testing
  # ============================================================
  azure-load-test:
    name: Azure Load Testing
    runs-on: ubuntu-latest
    if: contains(github.event.inputs.target_url, 'azurecontainerapps.io')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create Azure Load Test
        uses: azure/load-testing@v1
        with:
          loadTestConfigFile: 'tests/load/azure-load-test.yaml'
          resourceGroup: 'edumatch-rg'
          loadTestResource: 'edumatch-load-test'
          env: |
            [
              {
                "name": "TARGET_URL",
                "value": "${{ github.event.inputs.target_url }}"
              },
              {
                "name": "DURATION",
                "value": "${{ github.event.inputs.duration }}"
              },
              {
                "name": "VUS",
                "value": "${{ github.event.inputs.vus }}"
              }
            ]

      - name: Upload Azure Load Test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: azure-load-test-results
          path: loadTest/

  # ============================================================
  # Job 3: Performance Comparison
  # ============================================================
  performance-comparison:
    name: Performance Comparison
    runs-on: ubuntu-latest
    needs: [k6-load-test]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download test results
        uses: actions/download-artifact@v3
        with:
          name: k6-load-test-results
          path: reports/

      - name: Analyze results
        run: |
          echo "# Performance Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Extract key metrics from k6 JSON output
          if [ -f "reports/k6-results.json" ]; then
            echo "## Key Metrics" >> $GITHUB_STEP_SUMMARY
            echo "- Total Requests: $(jq -r '.metrics.http_reqs.values.count' reports/k6-results.json)" >> $GITHUB_STEP_SUMMARY
            echo "- Failed Requests: $(jq -r '.metrics.http_req_failed.values.passes' reports/k6-results.json)" >> $GITHUB_STEP_SUMMARY
            echo "- Avg Response Time: $(jq -r '.metrics.http_req_duration.values.avg' reports/k6-results.json)ms" >> $GITHUB_STEP_SUMMARY
            echo "- P95 Response Time: $(jq -r '.metrics.http_req_duration.values."p(95)"' reports/k6-results.json)ms" >> $GITHUB_STEP_SUMMARY
            echo "- P99 Response Time: $(jq -r '.metrics.http_req_duration.values."p(99)"' reports/k6-results.json)ms" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check performance thresholds
        run: |
          # Fail if P95 > 2000ms or error rate > 1%
          P95=$(jq -r '.metrics.http_req_duration.values."p(95)"' reports/k6-results.json)
          ERROR_RATE=$(jq -r '.metrics.http_req_failed.values.rate' reports/k6-results.json)
          
          if (( $(echo "$P95 > 2000" | bc -l) )); then
            echo "❌ P95 response time exceeded threshold (${P95}ms > 2000ms)"
            exit 1
          fi
          
          if (( $(echo "$ERROR_RATE > 0.01" | bc -l) )); then
            echo "❌ Error rate exceeded threshold (${ERROR_RATE} > 1%)"
            exit 1
          fi
          
          echo "✅ Performance within acceptable thresholds"

  # ============================================================
  # Job 4: Service-Specific Load Tests
  # ============================================================
  service-load-tests:
    name: Service Load Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: 
          - name: auth-service
            port: 8081
            endpoint: /api/auth/login
          - name: scholarship-service
            port: 8082
            endpoint: /api/scholarships
          - name: chat-service
            port: 8084
            endpoint: /api/chats/health
          - name: matching-service
            port: 8000
            endpoint: /health
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Start service
        run: |
          docker compose -f docker-compose.test.yml up -d ${{ matrix.service.name }}
          sleep 30

      - name: Wait for service health
        run: |
          timeout 120 bash -c 'until curl -f http://localhost:${{ matrix.service.port }}${{ matrix.service.endpoint }}; do sleep 5; done'

      - name: Run load test for ${{ matrix.service.name }}
        run: |
          k6 run tests/load/service-test.js \
            --env TARGET_URL=http://localhost:${{ matrix.service.port }} \
            --env ENDPOINT=${{ matrix.service.endpoint }} \
            --env SERVICE_NAME=${{ matrix.service.name }} \
            --out json=reports/${{ matrix.service.name }}-results.json

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.service.name }}-load-test
          path: reports/

      - name: Cleanup
        if: always()
        run: docker compose -f docker-compose.test.yml down -v
