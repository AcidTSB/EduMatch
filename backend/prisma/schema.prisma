// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  STUDENT
  PROVIDER
  UNIVERSITY
  PROFESSOR
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_VERIFICATION
}

enum SubscriptionType {
  FREE
  PREMIUM
  ENTERPRISE
}

enum ApplicationStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  ACCEPTED
  REJECTED
  WAITLISTED
}

enum ScholarshipType {
  UNDERGRADUATE
  GRADUATE
  PHD
  POSTDOC
  RESEARCH
}

enum ScholarshipStatus {
  DRAFT
  PUBLISHED
  CLOSED
  EXPIRED
}

model User {
  id                String             @id @default(cuid())
  email             String             @unique
  firebaseUid       String?            @unique
  passwordHash      String?
  role              UserRole
  status            UserStatus         @default(PENDING_VERIFICATION)
  subscriptionType  SubscriptionType   @default(FREE)
  emailVerified     Boolean            @default(false)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  lastLoginAt       DateTime?

  // Relations
  profile           Profile?
  scholarships      Scholarship[]
  applications      Application[]
  notifications     Notification[]
  sentMessages      Message[]         @relation("SentMessages")
  receivedMessages  Message[]         @relation("ReceivedMessages")
  matchingScores    MatchingScore[]

  @@map("users")
}

model Profile {
  id                String    @id @default(cuid())
  userId            String    @unique
  firstName         String
  lastName          String
  avatar            String?
  phone             String?
  dateOfBirth       DateTime?
  nationality       String?
  currentLocation   String?
  bio               String?
  
  // Student specific fields
  university        String?
  major             String?
  gpa               Float?
  graduationYear    Int?
  currentLevel      String?   // undergraduate, graduate, phd
  
  // Provider specific fields
  organizationName  String?
  position          String?
  website           String?
  verified          Boolean   @default(false)
  
  // Skills and interests
  skills            String[]  // JSON array
  interests         String[]  // JSON array
  languages         String[]  // JSON array
  
  // Academic background
  education         Json?     // Detailed education history
  experience        Json?     // Work/research experience
  publications      Json?     // Publications and achievements
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("profiles")
}

model Scholarship {
  id                String            @id @default(cuid())
  providerId        String
  title             String
  description       String
  type              ScholarshipType
  status            ScholarshipStatus @default(DRAFT)
  
  // Basic info
  university        String
  department        String?
  location          String
  isRemote          Boolean           @default(false)
  
  // Financial details
  amount            Float?
  currency          String            @default("USD")
  duration          Int?              // in months
  isPaidMonthly     Boolean           @default(true)
  
  // Requirements
  requirements      Json              // Detailed requirements
  eligibility       Json              // Eligibility criteria
  requiredSkills    String[]
  preferredSkills   String[]
  minGpa            Float?
  
  // Dates
  applicationDeadline DateTime
  startDate         DateTime?
  endDate           DateTime?
  
  // Additional info
  tags              String[]
  website           String?
  contactEmail      String?
  isVisible         Boolean           @default(true)
  viewCount         Int               @default(0)
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  provider          User              @relation(fields: [providerId], references: [id], onDelete: Cascade)
  applications      Application[]
  matchingScores    MatchingScore[]

  @@map("scholarships")
}

model Application {
  id                String              @id @default(cuid())
  applicantId       String
  scholarshipId     String
  status            ApplicationStatus   @default(DRAFT)
  
  // Application content
  coverLetter       String?
  cv                String?             // File path or URL
  additionalDocs    String[]            // Array of file paths/URLs
  customAnswers     Json?               // Answers to custom questions
  
  // Tracking
  submittedAt       DateTime?
  reviewedAt        DateTime?
  respondedAt       DateTime?
  feedback          String?
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  // Relations
  applicant         User                @relation(fields: [applicantId], references: [id], onDelete: Cascade)
  scholarship       Scholarship         @relation(fields: [scholarshipId], references: [id], onDelete: Cascade)
  messages          Message[]

  @@unique([applicantId, scholarshipId])
  @@map("applications")
}

model MatchingScore {
  id              String      @id @default(cuid())
  userId          String
  scholarshipId   String
  score           Float       // 0.0 to 1.0
  factors         Json        // Detailed breakdown of matching factors
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  scholarship     Scholarship @relation(fields: [scholarshipId], references: [id], onDelete: Cascade)

  @@unique([userId, scholarshipId])
  @@map("matching_scores")
}

model Notification {
  id              String      @id @default(cuid())
  userId          String
  title           String
  message         String
  type            String      // email, push, in_app
  isRead          Boolean     @default(false)
  data            Json?       // Additional data for the notification
  scheduledAt     DateTime?   // For scheduled notifications
  sentAt          DateTime?
  createdAt       DateTime    @default(now())

  // Relations
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model Message {
  id              String      @id @default(cuid())
  senderId        String
  receiverId      String
  applicationId   String?
  subject         String?
  content         String
  isRead          Boolean     @default(false)
  attachments     String[]    // Array of file paths/URLs
  createdAt       DateTime    @default(now())

  // Relations
  sender          User        @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver        User        @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  application     Application? @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@map("messages")
}

// Analytics and tracking
model UserActivity {
  id              String      @id @default(cuid())
  userId          String?
  sessionId       String?
  action          String      // login, view_scholarship, apply, etc.
  resource        String?     // resource ID being acted upon
  metadata        Json?       // Additional tracking data
  ipAddress       String?
  userAgent       String?
  createdAt       DateTime    @default(now())

  @@map("user_activities")
}

model SystemSettings {
  id              String      @id @default(cuid())
  key             String      @unique
  value           Json
  description     String?
  updatedAt       DateTime    @updatedAt

  @@map("system_settings")
}
