# ğŸ“„ TÃ i liá»‡u Cáº¥u hÃ¬nh & Test End-to-End (E2E): Auth â†” Matching

**Má»¥c tiÃªu:** Test 2 luá»“ng E2E:
1.  **Sync (API):** Client â” Gateway â” `auth-service` (Láº¥y Token) â” Client â” Gateway â” `matching-service` (DÃ¹ng Token).
2.  **Async (Event):** Client â” Gateway â” `auth-service` (ÄÄƒng kÃ½ User) â” RabbitMQ â” `matching-consumer` â” `matching-worker` â” `matching-db`.

---

## (A) âš ï¸ BÆ¯á»šC 1: Sá»¬A CODE (Báº®T BUá»˜C)

Báº¡n **PHáº¢I** sá»­a code `auth-service` (Java) Ä‘á»ƒ nÃ³ "báº¯n" (publish) event ra RabbitMQ.

### 1. ThÃªm Dependency vÃ o `pom.xml`

Äáº£m báº£o file `pom.xml` cá»§a báº¡n cÃ³ dependency nÃ y:

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-amqp</artifactId>
</dependency>
```

### 2. Cáº¥u hÃ¬nh Exchange (TÃ¹y chá»n, nhÆ°ng nÃªn cÃ³)

Táº¡o 1 file `RabbitMQConfig.java` Ä‘á»ƒ tá»± Ä‘á»™ng táº¡o `events_exchange` (giá»‘ng nhÆ° `consumer.py` Ä‘Ã£ lÃ m).

```java
// auth-service/src/main/java/com/example/jwt/example/config/RabbitMQConfig.java
package com.example.jwt.example.config;

import org.springframework.amqp.core.TopicExchange;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class RabbitMQConfig {

    public static final String EXCHANGE_NAME = "events_exchange";

    @Bean
    public TopicExchange eventsExchange() {
        return new TopicExchange(EXCHANGE_NAME, true, false);
    }
}
```

### 3. Sá»­a `AuthService.java` (Ä‘á»ƒ "báº¯n" event khi ÄÄƒng kÃ½)

Sá»­a file `AuthService.java` cá»§a báº¡n:

```java
package com.example.jwt.example.service;

// ... (cÃ¡c import khÃ¡c)
import org.springframework.amqp.rabbit.core.RabbitTemplate; // ThÃªm import
import java.util.Map; // ThÃªm import

@Service
@RequiredArgsConstructor
@Transactional
@Slf4j
public class AuthService {

    private final RabbitTemplate rabbitTemplate; // THÃŠM DÃ’NG NÃ€Y
    private final AuthenticationManager authenticationManager;
    // ... (cÃ¡c dependency khÃ¡c)

    public User registerUser(SignUpRequest signUpRequest) {
        log.info("Registering new user: {}", signUpRequest.getUsername());
        
        // ... (code validate username, email cá»§a báº¡n)

        User user = buildUserFromSignUpRequest(signUpRequest);
        // ... (code gÃ¡n Role)
        User savedUser = userRepository.save(user);

        // ... (code ghi AuditLog)
        
        // === Báº®N EVENT RA RABBITMQ ===
        try {
            Map<String, Object> eventPayload = Map.of(
                "userId", savedUser.getId().toString(), // Chuyá»ƒn sang String
                "email", savedUser.getEmail(),
                "skills", List.of(), // Gá»­i máº£ng rá»—ng
                "gpa", 0.0 // Gá»­i gpa máº·c Ä‘á»‹nh
            );
            rabbitTemplate.convertAndSend(
                "events_exchange",           // TÃªn Exchange
                "user.profile.updated",    // Routing Key
                eventPayload
            );
            log.info("Published user.profile.updated event for user ID: {}", savedUser.getId());
        } catch (Exception e) {
            log.error("Failed to publish RabbitMQ event for user: {}", savedUser.getId(), e);
            // KhÃ´ng re-throw, Ä‘Äƒng kÃ½ váº«n thÃ nh cÃ´ng
        }
        // =============================

        log.info("User {} registered successfully with ID: {}", savedUser.getUsername(), savedUser.getId());
        return savedUser;
    }
    
    // ... (cÃ¡c hÃ m khÃ¡c)
}
```

---

## (B) BÆ¯á»šC 2: Cáº¥u hÃ¬nh MÃ´i trÆ°á»ng (Docker Compose)

ÄÃ¢y lÃ  file `docker-compose.yml` (náº±m á»Ÿ thÆ° má»¥c gá»‘c) Ä‘á»ƒ cháº¡y E2E.

```yaml
version: '3.8'

services:
  
  # === 1. DATABASES ===
  auth-db:
    image: mysql:8.0
    container_name: auth-db
    environment:
      - MYSQL_ROOT_PASSWORD=@Saitamass2
      - MYSQL_DATABASE=jwt
    ports:
      - "3306:3306" # Cá»•ng MySQL
    volumes:
      - auth_db_data:/var/lib/mysql
    networks:
      - edumatch-net

  matching-db:
    image: postgres:14-alpine
    container_name: matching-db
    environment:
      - POSTGRES_USER=matching_user
      - POSTGRES_PASSWORD=matching_pass
      - POSTGRES_DB=matching_db
    ports:
      - "5432:5432" # Cá»•ng PostgreSQL
    volumes:
      - matching_db_data:/var/lib/postgresql/data
    networks:
      - edumatch-net

  # === 2. MESSAGE BROKER ===
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: rabbitmq
    ports:
      - "5672:5672"  # Cá»•ng giao tiáº¿p
      - "15672:15672" # Cá»•ng UI (truy cáº­p localhost:15672)
    networks:
      - edumatch-net

  # === 3. AUTH SERVICE (Java) ===
  auth-service:
    container_name: auth-service
    build:
      context: ./backend-java/auth-service # Trá» Ä‘áº¿n folder auth-service cá»§a báº¡n
      dockerfile: Dockerfile
    ports:
      - "8081:8081" # Cá»•ng service Java
    environment:
      # Chá» DB sáºµn sÃ ng (Cáº§n config trong code Java Ä‘á»ƒ Ä‘á»c)
      - SPRING_DATASOURCE_URL=jdbc:mysql://auth-db:3306/jwt?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=@Saitamass2
      - SPRING_RABBITMQ_HOST=rabbitmq # Cho RabbitTemplate
    depends_on:
      - auth-db
      - rabbitmq
    networks:
      - edumatch-net

  # === 4. MATCHING SERVICE (Python) ===
  matching-service:
    container_name: matching-service
    build:
      context: ./matching-service # Trá» Ä‘áº¿n folder matching-service
      dockerfile: Dockerfile
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://matching_user:matching_pass@matching-db:5432/matching_db
      - CELERY_BROKER_URL=amqp://guest:guest@rabbitmq:5672//
      # QUAN TRá»ŒNG: JWT Secret pháº£i khá»›p 100% vá»›i file Java
      - JWT_SECRET=EduMatch_Super_Secret_Key_!@#_DoNotShare_!@# 
      - JWT_ALGORITHM=HS512 # Java Ä‘ang dÃ¹ng HS512, Python pháº£i dÃ¹ng HS512
    depends_on:
      - matching-db
      - rabbitmq
    networks:
      - edumatch-net

  matching-celery-worker:
    container_name: matching-celery-worker
    build:
      context: ./matching-service
    command: celery -A app.celery_app worker --loglevel=info
    environment:
      - DATABASE_URL=postgresql://matching_user:matching_pass@matching-db:5432/matching_db
      - CELERY_BROKER_URL=amqp://guest:guest@rabbitmq:5672//
    depends_on:
      - matching-db
      - rabbitmq
    networks:
      - edumatch-net

  matching-consumer:
    container_name: matching-consumer
    build:
      context: ./matching-service
    command: python -m app.consumer
    environment:
      - RABBITMQ_HOST=rabbitmq
    depends_on:
      - rabbitmq
      - matching-celery-worker
    networks:
      - edumatch-net

# === 5. API GATEWAY (Nginx) ===
# (Báº¡n cÃ³ thá»ƒ thÃªm Nginx Gateway vÃ o Ä‘Ã¢y, trá» Ä‘áº¿n
# auth-service:8081 vÃ  matching-service:8000)

# Máº¡ng áº£o
networks:
  edumatch-net:
    driver: bridge

# Volumes
volumes:
  auth_db_data:
  matching_db_data:
```
*(**LÆ°u Ã½ quan trá»ng:** `MatchingService` cá»§a báº¡n (Python) Ä‘ang dÃ¹ng `HS256` trong khi `AuthService` (Java) Ä‘ang dÃ¹ng `HS512`. Báº¡n pháº£i sá»­a `matching-service/app/config.py` thÃ nh `JWT_ALGORITHM: str = "HS512"` Ä‘á»ƒ nÃ³ khá»›p nhau).*

---

## (C) BÆ¯á»šC 3: Ká»‹ch báº£n Test E2E

### 1. Test Luá»“ng Äá»“ng bá»™ (Sync - API Call)

**Má»¥c tiÃªu:** Kiá»ƒm tra `auth-service` (Java) táº¡o token, vÃ  `matching-service` (Python) xÃ¡c thá»±c token Ä‘Ã³ thÃ nh cÃ´ng.

| ID | Ká»‹ch báº£n | API | Body / Header | Káº¿t quáº£ mong Ä‘á»£i |
| :--- | :--- | :--- | :--- | :--- |
| **E2E-SYNC-01** | Láº¥y Token (Java) | `POST http://localhost:8081/api/auth/signin` | `{"username": "admin", "password": "admin123"}` | `200 OK`. Láº¥y `accessToken` (TOKEN_ADMIN). |
| **E2E-SYNC-02** | Gá»i API (Python) | `GET http://localhost:8000/api/v1/recommendations/applicant/app_001` | `Authorization: Bearer TOKEN_ADMIN` | `200 OK` (Hoáº·c 404 náº¿u data khÃ´ng tá»“n táº¡i). **KhÃ´ng Ä‘Æ°á»£c** tráº£ vá» `401 Unauthorized`. |
| **E2E-SYNC-03** | Gá»i API (Python) (Sai) | `GET http://localhost:8000/api/v1/recommendations/applicant/app_001` | (KhÃ´ng cÃ³ Header) | `401 Unauthorized`. XÃ¡c minh `auth.py` hoáº¡t Ä‘á»™ng. |

### 2. Test Luá»“ng Báº¥t Ä‘á»“ng bá»™ (Async - RabbitMQ Event)

**Má»¥c tiÃªu:** Kiá»ƒm tra `auth-service` (Java) "báº¯n" event `user.profile.updated` khi Ä‘Äƒng kÃ½ user, vÃ  `matching-service` (Python) nháº­n Ä‘Æ°á»£c vÃ  lÆ°u vÃ o DB.

**Luá»“ng Test (Test Flow):**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Tester Â  â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
Â  Â  â”‚ 1. (Check DB Python)
Â  Â  â”‚ docker exec matching-db psql -U matching_user -d matching_db -c 
Â  Â  â”‚   "SELECT COUNT(*) FROM applicant_features WHERE applicant_id = '100'"
Â  Â  â”‚ (Káº¿t quáº£ mong Ä‘á»£i: 0)
Â  Â  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Tester Â  Â  Â  Â  â”‚
â”‚ (Gá»i API Java)â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Â  Â  â”‚ 2. (Gá»ŒI API AUTH-SERVICE)
Â  Â  â”‚ curl -X POST http://localhost:8081/api/auth/signup \
Â  Â  â”‚   -H "Content-Type: application/json" \
Â  Â  â”‚   -d '{"username": "e2e_user", "email": "e2e@test.com", "password": "password123", "id": 100}'
Â  Â  â”‚ (AuthService sáº½ lÆ°u user vÃ o MySQL VÃ€ báº¯n event "user.profile.updated" ra RabbitMQ)
Â  Â  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RabbitMQ Â  Â  Â  â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Â  Â  â”‚ 3. (Matching-Consumer nháº­n event...)
Â  Â  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Matching-Workerâ”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Â  Â  â”‚ 4. (Worker tiá»n xá»­ lÃ½ vÃ  lÆ°u vÃ o PostgreSQL...)
Â  Â  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Tester Â  â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
Â  Â  â”‚ 5. (Chá» 10 giÃ¢y...)
Â  Â  â”‚ (Check DB Python Láº§n 2)
Â  Â  â”‚ docker exec matching-db psql -U matching_user -d matching_db -c 
Â  Â  â”‚   "SELECT COUNT(*) FROM applicant_features WHERE applicant_id = '100'"
Â  Â  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Káº¿t quáº£ mong Ä‘á»£i â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Â  Â  â”‚ 6. (PASS)
Â  Â  â”‚ Káº¿t quáº£: 1
```