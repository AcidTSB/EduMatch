# ğŸ§ª Káº¿ hoáº¡ch Test Tá»•ng thá»ƒ (Master Test Plan)

**NgÃ y test:** 09/11/2025
**Má»¥c tiÃªu:** XÃ¡c minh 3 service (`Auth`, `Scholarship`, `Matching`) hoáº¡t Ä‘á»™ng Ä‘Ãºng logic vÃ  giao tiáº¿p End-to-End (E2E) chÃ­nh xÃ¡c qua cáº£ 2 luá»“ng (Sync API vÃ  Async RabbitMQ).

---

## 1. ğŸ› ï¸ Tiá»n Ä‘iá»u kiá»‡n (Báº¯t buá»™c)

### 1.1. Láº¥y 3 Token (Vai trÃ²)

Äá»ƒ test, báº¡n cáº§n 3 Token (JWT) á»©ng vá»›i 3 vai trÃ² (Role) khÃ¡c nhau.

| ID | Vai trÃ² | CÃ¡ch láº¥y | Ghi chÃº |
| :--- | :--- | :--- | :--- |
| **T-01** | `TOKEN_ADMIN` | `POST /api/auth/signin` (dÃ¹ng `admin` / `admin123`) | DÃ¹ng Ä‘á»ƒ duyá»‡t há»c bá»•ng, quáº£n lÃ½ user. |
| **T-02** | `TOKEN_STUDENT`| `POST /api/auth/signup` (táº¡o user má»›i) vÃ  `signin` | DÃ¹ng Ä‘á»ƒ ná»™p Ä‘Æ¡n, xem gá»£i Ã½. |
| **T-03** | `TOKEN_PROVIDER`| DÃ¹ng `TOKEN_ADMIN` gá»i `POST /api/admin/create-employer`, sau Ä‘Ã³ `signin` | DÃ¹ng Ä‘á»ƒ Ä‘Äƒng há»c bá»•ng, duyá»‡t Ä‘Æ¡n. |

---

## 2. ğŸ§ª Test Case: `AuthService` (Java)

**Má»¥c tiÃªu:** Test logic ná»™i bá»™ cá»§a `auth-service` (XÃ¡c thá»±c, Quáº£n lÃ½ User, Audit).

| ID | Chá»©c nÄƒng | API | Role | Káº¿t quáº£ mong Ä‘á»£i |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **AUTH-01**| ÄÄƒng kÃ½ | `POST /api/auth/signup` | Public | `201 Created`. User Ä‘Æ°á»£c táº¡o vá»›i `enabled: false`. Email Ä‘Æ°á»£c gá»­i. |
| **AUTH-02**| XÃ¡c minh Email | `GET /api/auth/verify?code=...` | Public | `200 OK`. User Ä‘á»•i `enabled` thÃ nh `true`. |
| **AUTH-03**| ÄÄƒng nháº­p | `POST /api/auth/signin` | Public | `200 OK`. Tráº£ vá» `accessToken` (JWT). |
| **AUTH-04**| Láº¥y Profile | `GET /api/user/me` | `STUDENT` | `200 OK`. Tráº£ vá» `UserSummary`. |
| **AUTH-05**| PhÃ¢n quyá»n (Fail) | `GET /api/admin/users` | `STUDENT` | `403 Forbidden` (Access Denied). |
| **AUTH-06**| Láº¥y User (Admin) | `GET /api/admin/users` | `ADMIN` | `200 OK`. Tráº£ vá» danh sÃ¡ch `UserResponse`. |
| **AUTH-07**| KhÃ³a User (Admin) | `PATCH /api/admin/users/{id}/toggle-status` | `ADMIN` | `200 OK`. User `enabled` Ä‘á»•i tráº¡ng thÃ¡i. |
| **AUTH-08**| XÃ³a User (Admin) | `DELETE /api/admin/users/{id}` | `ADMIN` | `200 OK` (hoáº·c 204). (Test nÃ y sáº½ PASS vÃ¬ `UserService.java` Ä‘Ã£ sá»­a lá»—i FK, gá»i `refreshTokenService.deleteByUserId` trÆ°á»›c) |
| **AUTH-09**| Láº¥y Audit Log | `GET /api/admin/audit/logs` | `ADMIN` | `200 OK`. Kiá»ƒm tra log `DELETE_USER` (tá»« AUTH-08) pháº£i tá»“n táº¡i. |
| **AUTH-10**| API Ná»™i bá»™ | `GET /api/internal/user/admin` | `STUDENT` | `200 OK`. (VÃ¬ API nÃ y chá»‰ yÃªu cáº§u `isAuthenticated()`, khÃ´ng yÃªu cáº§u Admin). |

---

## 3. ğŸ§ª Test Case: `ScholarshipService` (Java)

**Má»¥c tiÃªu:** Test logic nghiá»‡p vá»¥ chÃ­nh (CRUD, Ná»™p Ä‘Æ¡n) theo tÃ i liá»‡u Test Plan.

| ID | Chá»©c nÄƒng | API (Giáº£ Ä‘á»‹nh) | Role | Káº¿t quáº£ mong Ä‘á»£i |
| :--- | :--- | :--- | :--- | :--- |
| **SCH-01**| Provider ÄÄƒng HB | `POST /api/scholarships` | `PROVIDER` | `201 Created`. Há»c bá»•ng Ä‘Æ°á»£c lÆ°u vÃ o `scholarship-db` (status `PENDING`). |
| **SCH-02**| Admin Duyá»‡t HB | `PATCH /api/admin/scholarships/{id}/approve` | `ADMIN` | `200 OK`. Status Ä‘á»•i thÃ nh `APPROVED`. |
| **SCH-03**| Student Ná»™p Ä‘Æ¡n | `POST /api/applications` | `STUDENT` | `201 Created`. ÄÆ¡n Ä‘Æ°á»£c lÆ°u vÃ o `applications` vÃ  `application_documents`. |
| **SCH-04**| Student Ná»™p Láº¡i | `POST /api/applications` (Giá»‘ng SCH-03) | `STUDENT` | `409 Conflict` (Lá»—i: ÄÃ£ ná»™p). |
| **SCH-05**| Provider Duyá»‡t ÄÆ¡n| `PATCH /api/applications/{id}/status` | `PROVIDER` | `200 OK`. Status cá»§a application Ä‘á»•i thÃ nh `APPROVED`. |

---

## 4. ğŸ§ª Test Case: `MatchingService` (Python)

**Má»¥c tiÃªu:** Test logic ná»™i bá»™ cá»§a `matching-service` (TÃ­nh Ä‘iá»ƒm nhanh, TÃ­nh Ä‘iá»ƒm cháº­m).

| ID | Chá»©c nÄƒng | API | Role | Káº¿t quáº£ mong Ä‘á»£i |
| :--- | :--- | :--- | :--- | :--- |
| **MAT-01**| TÃ­nh Ä‘iá»ƒm Nhanh | `POST /api/v1/match/score` | Public | `200 OK`. Tráº£ vá» `overallScore` (tÃ­nh báº±ng `calculate_rule_based_score`). |
| **MAT-02**| Láº¥y Gá»£i Ã½ (Fail) | `GET /api/v1/recommendations/applicant/123` | (No Token) | `401 Unauthorized` (XÃ¡c minh `auth.py` hoáº¡t Ä‘á»™ng). |
| **MAT-03**| Láº¥y Gá»£i Ã½ (OK) | `GET /api/v1/recommendations/applicant/123` | `STUDENT` | `200 OK`. Cháº¥p nháº­n 2-5 giÃ¢y, tráº£ vá» danh sÃ¡ch (tÃ­nh báº±ng `calculate_ml_based_scores`). |

---

## 5. ğŸ”„ Test Case: End-to-End (E2E)

**Má»¥c tiÃªu:** Test cÃ¡c luá»“ng giao tiáº¿p phá»©c táº¡p giá»¯a cÃ¡c service (Ä‘Ã£ sá»­a 2 lá»—i á»Ÿ Tiá»n Ä‘iá»u kiá»‡n 1.2).

### Luá»“ng E2E-Sync-1: `Auth` (Java) â” `Matching` (Python) - (XÃ¡c thá»±c)
* **Ká»‹ch báº£n:** DÃ¹ng Token (JWT) cá»§a `auth-service` Ä‘á»ƒ gá»i `matching-service`.
* **Test:**
    1.  Gá»i `POST /api/auth/signin` (Java) â” Láº¥y `TOKEN_STUDENT`.
    2.  DÃ¹ng `TOKEN_STUDENT` gá»i `GET /api/v1/recommendations/applicant/123` (Python).
* **Káº¿t quáº£ (PASS):** `200 OK`. Python Ä‘Ã£ hiá»ƒu token HS512 cá»§a Java.

### Luá»“ng E2E-Sync-2: `Scholarship` (Java) â” `Auth` (Java) & `Matching` (Python) - (Xem chi tiáº¿t)
* **Ká»‹ch báº£n:** Khi Student gá»i `GET /api/scholarships/{id}`, `ScholarshipService` (Java) pháº£i gá»i 2 service khÃ¡c Ä‘á»ƒ lÃ m giÃ u (enrich) dá»¯ liá»‡u.
* **Test:**
    1.  DÃ¹ng `TOKEN_STUDENT` gá»i `GET /api/scholarships/{id_hoc_bong}`.
* **Káº¿t quáº£ (PASS):** Response `200 OK` (JSON) tráº£ vá» pháº£i chá»©a **Cáº¢ HAI** trÆ°á»ng:
    1.  `"applicant_snapshot": {...}` (Láº¥y tá»« `AuthService` - `GET /api/internal/user/...`).
    2.  `"matchScore": 82.5` (Láº¥y tá»« `MatchingService` - `POST /api/v1/match/score`).

### Luá»“ng E2E-Async-1: `Auth` (Java) â” RabbitMQ â” `Matching` (Python) - (ÄÄƒng kÃ½)
* **Ká»‹ch báº£n:** Khi Student Ä‘Äƒng kÃ½ (`POST /api/auth/signup`), `AuthService` (Java) pháº£i "báº¯n" event `user.profile.updated`. `MatchingService` (Python) pháº£i nháº­n vÃ  lÆ°u vÃ o `matching-db`.
* **Test:**
    1.  (Check DB Python) Query `applicant_features` (vÃ­ dá»¥: `WHERE email = 'e2e-async-1@test.com'`) â” Káº¿t quáº£: 0.
    2.  (Gá»i API Java) `POST /api/auth/signup` vá»›i email `e2e-async-1@test.com`.
    3.  (Chá» 10 giÃ¢y).
    4.  (Check DB Python Láº§n 2) Query láº¡i â” **Káº¿t quáº£ (PASS):** 1 (Má»™t hÃ ng má»›i Ä‘Ã£ Ä‘Æ°á»£c táº¡o bá»Ÿi worker).

### Luá»“ng E2E-Async-2: `Scholarship` (Java) â” RabbitMQ â” `Matching` (Python) - (ÄÄƒng há»c bá»•ng)
* **Ká»‹ch báº£n:** Khi Provider Ä‘Äƒng há»c bá»•ng (`POST /api/scholarships`), `ScholarshipService` (Java) pháº£i "báº¯n" event `scholarship.created`. `MatchingService` (Python) pháº£i nháº­n vÃ  lÆ°u vÃ o `matching-db` (báº£ng `opportunity_features`).
* **Test:**
    1.  (Check DB Python) Query `opportunity_features` (vÃ­ dá»¥: `WHERE opportunity_id = 'opp-e2e-1'`) â” Káº¿t quáº£: 0.
    2.  (Gá»i API Java) DÃ¹ng `TOKEN_PROVIDER`, gá»i `POST /api/scholarships` (Ä‘á»ƒ táº¡o há»c bá»•ng `opp-e2e-1`).
    3.  (Chá» 10 giÃ¢y).
    4.  (Check DB Python Láº§n 2) Query láº¡i â” **Káº¿t quáº£ (PASS):** 1.

### Luá»“ng E2E-Async-3: `Scholarship` (Java) â” RabbitMQ â” `ChatService` (Java) - (ThÃ´ng bÃ¡o)
* **Ká»‹ch báº£n:** Khi Provider duyá»‡t Ä‘Æ¡n (`PATCH /api/applications/{id}/status`), `ScholarshipService` (Java) pháº£i "báº¯n" event `application.status.changed`. `ChatService` (Java) pháº£i nháº­n vÃ  lÆ°u vÃ o `chat-db` (báº£ng `notifications`).
* **Test:**
    1.  (Check DB Chat) Query `notifications` (vÃ­ dá»¥: `WHERE user_id = 'student-123'`) â” Káº¿t quáº£: 0.
    2.  (Gá»i API Java) DÃ¹ng `TOKEN_PROVIDER`, gá»i `PATCH /api/applications/{id_cua_student_123}/status` (Body: `{"status": "APPROVED"}`).
    3.  (Chá» 5 giÃ¢y).
    4.  (Check DB Chat Láº§n 2) Query láº¡i â” **Káº¿t quáº£ (PASS):** 1 (Má»™t thÃ´ng bÃ¡o má»›i "Há»“ sÆ¡ cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c duyá»‡t" Ä‘Ã£ Ä‘Æ°á»£c táº¡o).