# üß™ K·∫ø ho·∫°ch Test (Test Plan): Scholarship Service (Java)

**Ng√†y test:** 09/11/2025
**M·ª•c ti√™u:** X√°c minh `ScholarshipService` ho·∫°t ƒë·ªông ƒë√∫ng logic nghi·ªáp v·ª• (CRUD, N·ªôp ƒë∆°n, Bookmark) v√† giao ti·∫øp End-to-End (E2E) ch√≠nh x√°c v·ªõi c√°c service kh√°c (`AuthService`, `MatchingService`, `ChatService`).
**Tr·∫°ng th√°i:** üü¢ S·∫µn s√†ng Test

---

## 1. üõ†Ô∏è Ti·ªÅn ƒëi·ªÅu ki·ªán (B·∫Øt bu·ªôc)

### 1.1. L·∫•y 3 Token (Vai tr√≤)

ƒê·ªÉ test service n√†y, ch√∫ng ta c·∫ßn 3 lo·∫°i Token (l·∫•y t·ª´ `AuthService`):

1.  `TOKEN_ADMIN`: L·∫•y b·∫±ng t√†i kho·∫£n `admin` / `admin123`. D√πng ƒë·ªÉ *duy·ªát* h·ªçc b·ªïng.
2.  `TOKEN_PROVIDER`: L·∫•y b·∫±ng t√†i kho·∫£n `employer` (Gi√°o s∆∞/Tr∆∞·ªùng h·ªçc) m√† Admin t·∫°o (API `POST /api/admin/create-employer`). D√πng ƒë·ªÉ *ƒëƒÉng* (Post) h·ªçc b·ªïng.
3.  `TOKEN_STUDENT`: L·∫•y b·∫±ng t√†i kho·∫£n `testuser` / `password123`. D√πng ƒë·ªÉ *n·ªôp ƒë∆°n* (Apply).

### 1.2. ‚ö†Ô∏è L·ªói E2E C·∫ßn S·ª≠a (B·∫ÆT BU·ªòC)

Test E2E **S·∫º TH·∫§T B·∫†I** n·∫øu m√†y kh√¥ng s·ª≠a 2 l·ªói kh√¥ng t∆∞∆°ng th√≠ch (mismatch) n√†y:

1.  **L·ªói SYNC (JWT):** `auth-service` (Java) v√† `scholarship-service` (Java) c·ªßa m√†y ƒëang t·∫°o token b·∫±ng `HS512` (v√¨ `jjwt` t·ª± ch·ªçn do key b√≠ m·∫≠t qu√° d√†i). Nh∆∞ng `matching-service` (Python) l·∫°i ƒëang check b·∫±ng `HS256`.
    * **S·ª≠a:** S·ª≠a `matching-service/app/config.py` th√†nh `JWT_ALGORITHM: str = "HS512"` v√† `JWT_SECRET` (cho kh·ªõp 100%).

2.  **L·ªói ASYNC (RabbitMQ):** (L·ªói n√†y v·∫´n c√≤n) `matching-consumer` (Pika) ƒë·∫©y task v√†o queue `scholarship_events_queue`, nh∆∞ng `celery_app` (Worker) l·∫°i ƒëang "nghe" queue `celery` (v√¨ `task_routes` b·ªã comment).
    * **S·ª≠a:** **B·ªè comment** kh·ªëi `celery_app.conf.task_routes` trong file `matching-service/app/celery_app.py`.

---

## 2. üß™ Test Case ƒê∆°n l·∫ª (Logic n·ªôi b·ªô)

**M·ª•c ti√™u:** Test logic CRUD n·ªôi b·ªô c·ªßa `ScholarshipService` (ƒë·ªçc/ghi v√†o `scholarship-db`) v√† ph√¢n quy·ªÅn.

### 2.1. Test Ph√¢n quy·ªÅn (SecurityConfig)

| ID | Role | API | K·∫øt qu·∫£ mong ƒë·ª£i |
| :--- | :--- | :--- | :--- |
| **SEC-01**| (Kh√¥ng c√≥) | `GET /api/scholarships` | `200 OK` (Public) |
| **SEC-02**| (Kh√¥ng c√≥) | `POST /api/opportunities` | `401 Unauthorized` (C·∫ßn Token) |
| **SEC-03**| `STUDENT` | `POST /api/opportunities` | `403 Forbidden` (Sai Role) |
| **SEC-04**| `PROVIDER` | `POST /api/opportunities` | `201 Created` (ƒê√∫ng Role) |
| **SEC-05**| `PROVIDER` | `POST /api/applications` | `403 Forbidden` (Sai Role) |
| **SEC-06**| `STUDENT` | `POST /api/applications` | `201 Created` (ƒê√∫ng Role) |
| **SEC-07**| `STUDENT` | `GET /api/opportunities/all` | `403 Forbidden` (Sai Role) |
| **SEC-08**| `ADMIN` | `GET /api/opportunities/all` | `200 OK` (ƒê√∫ng Role) |

### 2.2. Test Logic Nghi·ªáp v·ª• (Controllers & Services)

| ID | Ch·ª©c nƒÉng | API | Role | K·∫øt qu·∫£ mong ƒë·ª£i |
| :--- | :--- | :--- | :--- | :--- |
| **OPP-01**| Provider ƒêƒÉng HB | `POST /api/opportunities` | `PROVIDER` | `201 Created`. Data ƒë∆∞·ª£c l∆∞u v√†o `opportunity`. Status l√† `PENDING`. |
| **OPP-02**| Admin Duy·ªát HB | `PUT /api/opportunities/{id}/moderate` | `ADMIN` | `200 OK`. `moderationStatus` ƒë·ªïi th√†nh `APPROVED`. |
| **OPP-03**| L·ªçc HB (Public) | `GET /api/scholarships?gpa=3.5` | Public | `200 OK`. Ch·ªâ tr·∫£ v·ªÅ c√°c HB c√≥ `minGpa <= 3.5` V√Ä `moderationStatus = 'APPROVED'` (theo logic `OpportunitySpecification.java`). |
| **APP-01**| Student N·ªôp ƒë∆°n | `POST /api/applications` | `STUDENT` | `201 Created`. Data ƒë∆∞·ª£c l∆∞u v√†o `applications` v√† `application_documents`. |
| **APP-02**| Student N·ªôp L·∫°i | `POST /api/applications` (Gi·ªëng APP-01) | `STUDENT` | `409 Conflict` (L·ªói: ƒê√£ n·ªôp - Logic n√†y m√†y ph·∫£i code trong `ApplicationService.java`). |
| **APP-03**| Provider Duy·ªát ƒê∆°n| `PUT /api/applications/{id}/status` | `PROVIDER` | `200 OK`. Status c·ªßa application ƒë·ªïi th√†nh `APPROVED`. |
| **BOOK-01**| Student Bookmark | `POST /api/bookmarks/{id}` | `STUDENT` | `200 OK`. Tr·∫£ v·ªÅ `{"bookmarked": true}`. |
| **BOOK-02**| Student B·ªè Bookmark| `POST /api/bookmarks/{id}` (L·∫ßn 2) | `STUDENT` | `200 OK`. Tr·∫£ v·ªÅ `{"bookmarked": false}` (Toggle logic). |

---

## 3. üîÑ Test Case: End-to-End (E2E)

### 3.1. Lu·ªìng E2E-Sync-1: `Scholarship` (Java) ‚ûî `Auth` (Java) & `Matching` (Python)

**M·ª•c ti√™u:** Khi Student xem chi ti·∫øt h·ªçc b·ªïng, `ScholarshipService` ph·∫£i g·ªçi (call) E2E 2 service kia.

* **Test:**
    1.  D√πng `TOKEN_STUDENT` (T-03), g·ªçi `GET /api/scholarships/{id_hoc_bong_da_duyet}`.
* **K·∫øt qu·∫£ (PASS):**
    * Response `200 OK`.
    * JSON tr·∫£ v·ªÅ (l√† `OpportunityDetailDto`) ph·∫£i ch·ª©a tr∆∞·ªùng `"matchScore": 82.5` (L·∫•y t·ª´ `MatchingService` - `getMatchingScore()`).
* **C√°ch ki·ªÉm tra (Debug):**
    * Check log `scholarship-service` ph·∫£i th·∫•y d√≤ng: "User ƒë√£ ƒëƒÉng nh·∫≠p, g·ªçi MatchingService ƒë·ªÉ l·∫•y ƒëi·ªÉm...".
    * Check log `matching-service` ph·∫£i th·∫•y d√≤ng: "Calculating score for...".

### 3.2. Lu·ªìng E2E-Sync-2: `Scholarship` (Java) ‚ûî `Auth` (Java)

**M·ª•c ti√™u:** Khi Student n·ªôp ƒë∆°n, `ScholarshipService` ph·∫£i g·ªçi (call) `AuthService` ƒë·ªÉ l·∫•y `UserDetailDto`.

* **Test:**
    1.  D√πng `TOKEN_STUDENT` (T-03), g·ªçi `POST /api/applications` (N·ªôp ƒë∆°n).
* **K·∫øt qu·∫£ (PASS):**
    * Response `201 Created`.
* **C√°ch ki·ªÉm tra (Debug):**
    * Check log `scholarship-service` ph·∫£i th·∫•y n√≥ g·ªçi `getUserDetailsFromAuthService`.
    * Check log `auth-service` ph·∫£i th·∫•y n√≥ nh·∫≠n ƒë∆∞·ª£c request `GET /api/internal/user/{username}`.

### 3.3. Lu·ªìng E2E-Async-1: `Scholarship` (Java) ‚ûî `Matching` (Python)

**M·ª•c ti√™u:** Khi Provider ƒëƒÉng h·ªçc b·ªïng, `ScholarshipService` ph·∫£i "b·∫Øn" event `scholarship.created` ƒë·ªÉ `MatchingService` (Python) nh·∫≠n v√† l∆∞u v√†o `matching-db` (b·∫£ng `opportunity_features`).

* **Test:**
    1.  **(Check DB Python)** Query `opportunity_features` (v√≠ d·ª•: `WHERE opportunity_id = '123'`) ‚ûî **K·∫øt qu·∫£: 0**.
    2.  **(G·ªçi API Java)** D√πng `TOKEN_PROVIDER` (T-02), g·ªçi `POST /api/opportunities` (H·ªçc b·ªïng m√†y t·∫°o s·∫Ω c√≥ ID l√† `123`).
    3.  **(Ch·ªù 10 gi√¢y)** (Cho RabbitMQ, Pika, v√† Celery x·ª≠ l√Ω).
    4.  **(Check DB Python L·∫ßn 2)** Query l·∫°i ‚ûî **K·∫øt qu·∫£ (PASS): 1**.
* **C√°ch ki·ªÉm tra (Debug):**
    * Check log `scholarship-service` ph·∫£i th·∫•y: "ƒê√£ g·ª≠i s·ª± ki·ªán 'scholarship.created'".
    * Check log `matching-consumer` ph·∫£i th·∫•y: "Received message... scholarship.created".
    * Check log `matching-celery-worker` ph·∫£i th·∫•y: "Processing scholarship.created... Successfully processed".

### 3.4. Lu·ªìng E2E-Async-2: `Scholarship` (Java) ‚ûî `ChatService` (Java)

**M·ª•c ti√™u:** Khi Provider duy·ªát ƒë∆°n, `ScholarshipService` (`ApplicationService.java`) ph·∫£i "b·∫Øn" event `notification.send.email` ƒë·ªÉ `ChatService` (Java) nh·∫≠n v√† l∆∞u v√†o `chat-db` (b·∫£ng `notifications`).

* **Test:**
    1.  **(Check DB Chat)** Query `notifications` (v√≠ d·ª•: `WHERE user_id = '456'`) ‚ûî **K·∫øt qu·∫£: 0**.
    2.  **(G·ªçi API Java)** D√πng `TOKEN_PROVIDER` (T-02), g·ªçi `PUT /api/applications/{id_don_cua_user_456}/status` (Body: `{"status": "APPROVED"}`).
    3.  **(Ch·ªù 5 gi√¢y)**.
    4.  **(Check DB Chat L·∫ßn 2)** Query l·∫°i ‚ûî **K·∫øt qu·∫£ (PASS): 1**.
* **C√°ch ki·ªÉm tra (Debug):**
    * Check log `scholarship-service` (`ApplicationService.java`) ph·∫£i th·∫•y: "ƒê√£ g·ª≠i s·ª± ki·ªán 'notification.send.email'".
    * Check log `chat-service` (Worker) ph·∫£i th·∫•y: "ƒê√£ nh·∫≠n event... ƒê√£ l∆∞u notification".