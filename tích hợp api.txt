 Tá»•ng quan vá» cÃ¡c file liÃªn quanAPI Gateway (nginx.conf): Äá»‹nh tuyáº¿n táº¥t cáº£ yÃªu cáº§u (request) tá»« /api/auth/... Ä‘áº¿n auth-service (backend).Backend Controller (AuthController.java): Cung cáº¥p 2 endpoint chÃ­nh táº¡i /api/auth:POST /signin: Nháº­n LoginRequest (gá»“m username vÃ  password).POST /signup: Nháº­n SignUpRequest (gá»“m username, email, password, v.v.).Frontend Service (src/services/auth.service.ts): ÄÃ¢y lÃ  file "há»£p Ä‘á»“ng" phÃ­a frontend, chá»©a cÃ¡c hÃ m login vÃ  register gá»i API báº±ng axios (thÃ´ng qua authApi). File nÃ y Ä‘Ã£ Ä‘Æ°á»£c viáº¿t chÃ­nh xÃ¡c.Frontend Context (src/lib/auth.ts): ÄÃ¢y lÃ  AuthProvider quáº£n lÃ½ state (tráº¡ng thÃ¡i) Ä‘Äƒng nháº­p. File nÃ y hiá»‡n Ä‘ang dÃ¹ng mockApi vÃ  cáº§n Ä‘Æ°á»£c cáº­p nháº­t.Frontend UI (src/app/auth/login/page.tsx, src/app/auth/register/page.tsx): CÃ¡c trang React nÆ¡i ngÆ°á»i dÃ¹ng nháº­p thÃ´ng tin.1. ğŸš€ TÃ­ch há»£p Luá»“ng ÄÄƒng nháº­p (Login Flow)ÄÃ¢y lÃ  cÃ¡c bÆ°á»›c tá»« khi ngÆ°á»i dÃ¹ng nháº¥n nÃºt "ÄÄƒng nháº­p" cho Ä‘áº¿n khi Ä‘Æ°á»£c chuyá»ƒn hÆ°á»›ng:BÆ°á»›c 1: Cáº­p nháº­t AuthProvider (File: src/lib/auth.ts)ÄÃ¢y lÃ  bÆ°á»›c quan trá»ng nháº¥t. Báº¡n cáº§n sá»­a hÃ m login trong AuthProvider Ä‘á»ƒ nÃ³ gá»i Ä‘áº¿n authService tháº­t thay vÃ¬ mockApi.QUAN TRá»ŒNG: Má»Ÿ file src/lib/auth.ts vÃ  thay tháº¿ code cÅ©.Code cÅ© (Ä‘ang dÃ¹ng mock):TypeScript// src/lib/auth.ts (CÅ¨)
// ...
import { mockApi } from '@/lib/mock-data';
// ...
  const login = async (credentials: LoginCredentials) => {
    try {
      // ...
      const response = await mockApi.auth.login(credentials); // <-- Äang dÃ¹ng MOCK
      // ...
    } // ...
  };
// ...
Code má»›i (sá»­ dá»¥ng authService tháº­t):TypeScript// src/lib/auth.ts (Má»šI)
import React, { createContext, useContext, useEffect, useState, ReactNode } from 'react';
import { AuthUser, AuthState, LoginCredentials, RegisterCredentials } from '@/types';
// THAY Äá»”I: Import authService tháº­t
import { authService } from '@/services/auth.service'; 
import { getFromLocalStorage, setToLocalStorage, removeFromLocalStorage } from '@/lib/utils';
import { setCookie, getCookie, deleteCookie } from '@/lib/cookies';

// ... (Giá»¯ nguyÃªn cÃ¡c interface vÃ  state) ...

export function AuthProvider({ children }: AuthProviderProps) {
  // ... (Giá»¯ nguyÃªn state vÃ  useEffect) ...

  const login = async (credentials: LoginCredentials) => {
    try {
      setError(null);
      setAuthState(prev => ({ ...prev, isLoading: true }));

      // THAY Äá»”I: Gá»i Ä‘áº¿n authService tháº­t
      // authService Ä‘Ã£ bao gá»“m cáº£ viá»‡c gá»i /signin vÃ  /me
      const response = await authService.login(credentials);

      if (response.user && response.accessToken) {
        const { user, accessToken } = response;

        // Service Ä‘Ã£ tá»± lÆ°u token vÃ o localStorage/cookie
        // Chá»‰ cáº§n cáº­p nháº­t state
        setAuthState(createAuthenticatedState(user));

        // Wait a bit then redirect to let cookies set
        setTimeout(() => {
          // Redirect based on user role
          if (user.roles.includes('ROLE_ADMIN')) { // ChÃº Ã½: role tá»« backend lÃ  "ROLE_ADMIN"
            window.location.href = '/admin/dashboard';
          } else if (user.roles.includes('ROLE_EMPLOYER')) {
            window.location.href = '/employer/dashboard';
          } else {
            window.location.href = '/user/dashboard';
          }
        }, 100);
      } else {
        // Handle failed login response
        setAuthState(prev => ({ ...prev, isLoading: false }));
        const errorMessage = 'Login failed';
        setError(errorMessage);
        throw new Error(errorMessage);
      }
    } catch (err) {
      const errorMessage = err instanceof Error ? err.message : 'Login failed';
      setError(errorMessage);
      setAuthState(resetAuthState());
      throw err;
    }
  };

  // ... (Giá»¯ nguyÃªn cÃ¡c hÃ m cÃ²n láº¡i, chÃºng ta sáº½ sá»­a register á»Ÿ bÆ°á»›c sau) ...
  
  // (HÃ m register, logout, refreshToken, v.v.)
}

// ... (Giá»¯ nguyÃªn useAuth) ...
BÆ°á»›c 2: PhÃ¢n tÃ­ch luá»“ng dá»¯ liá»‡u (KhÃ´ng cáº§n code)Khi AuthProvider Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t, luá»“ng Ä‘Äƒng nháº­p cá»§a báº¡n sáº½ nhÆ° sau:UI (login/page.tsx): NgÆ°á»i dÃ¹ng nháº¥n "Sign in". Component gá»i login({ email, password }) tá»« useAuth().Context (lib/auth.ts): HÃ m login (Ä‘Ã£ sá»­a á»Ÿ BÆ°á»›c 1) gá»i authService.login(credentials).Service (auth.service.ts):HÃ m login gá»­i yÃªu cáº§u POST Ä‘áº¿n endpoint signin (tá»©c lÃ  /api/auth/signin).Payload Mapping: NÃ³ gá»­i { username: data.email, password: data.password } Ä‘á»ƒ khá»›p vá»›i LoginRequest.java cá»§a backend.Backend (AuthService.java):XÃ¡c thá»±c ngÆ°á»i dÃ¹ng, táº¡o accessToken vÃ  refreshToken.Tráº£ vá» JwtAuthenticationResponse (chá»‰ chá»©a token).Service (auth.service.ts):Nháº­n token, lÆ°u vÃ o localStorage vÃ  document.cookie (Ä‘á»ƒ middleware.ts cÃ³ thá»ƒ Ä‘á»c).Thá»±c hiá»‡n cuá»™c gá»i thá»© hai: Gá»­i yÃªu cáº§u GET Ä‘áº¿n endpoint me (tá»©c lÃ  /api/auth/me) Ä‘á»ƒ láº¥y thÃ´ng tin user.LÆ°u thÃ´ng tin user vÃ o localStorage (auth_user) vÃ  document.cookie (auth_user).Tráº£ vá» object user cho Context.Context (lib/auth.ts):Nháº­n object user, gá»i setAuthState Ä‘á»ƒ cáº­p nháº­t tráº¡ng thÃ¡i toÃ n cá»¥c.Thá»±c hiá»‡n chuyá»ƒn hÆ°á»›ng (redirect) ngÆ°á»i dÃ¹ng Ä‘áº¿n trang dashboard tÆ°Æ¡ng á»©ng.2. ğŸš€ TÃ­ch há»£p Luá»“ng ÄÄƒng kÃ½ (Register Flow)TÆ°Æ¡ng tá»± nhÆ° login, báº¡n cáº§n cáº­p nháº­t hÃ m register trong AuthProvider.BÆ°á»›c 1: Cáº­p nháº­t AuthProvider (File: src/lib/auth.ts)Má»Ÿ láº¡i file src/lib/auth.ts vÃ  cáº­p nháº­t hÃ m register.Code cÅ© (Ä‘ang dÃ¹ng mock):TypeScript// src/lib/auth.ts (CÅ¨)
// ...
import { mockApi } from '@/lib/mock-data';
// ...
  const register = async (credentials: RegisterCredentials) => {
    try {
      // ...
      const response = await mockApi.auth.register(credentials); // <-- Äang dÃ¹ng MOCK
      // ...
    } // ...
  };
// ...
Code má»›i (sá»­ dá»¥ng authService tháº­t):TypeScript// src/lib/auth.ts (Sá»¬A HÃ€M REGISTER)

// ... (Giá»¯ nguyÃªn cÃ¡c import vÃ  hÃ m login Ä‘Ã£ sá»­a á»Ÿ trÃªn) ...

export function AuthProvider({ children }: AuthProviderProps) {
  // ... (Giá»¯ nguyÃªn state, useEffect, vÃ  hÃ m login) ...

  const register = async (credentials: RegisterCredentials) => {
    try {
      setError(null);
      setAuthState(prev => ({ ...prev, isLoading: true }));

      // THAY Äá»”I: Gá»i Ä‘áº¿n authService tháº­t
      // Backend (AuthController.java) tá»± Ä‘á»™ng login sau khi register
      // nÃªn service nÃ y tráº£ vá» cáº£ token vÃ  user
      const response = await authService.register(credentials);

      if (response.user && response.accessToken) {
        const { user } = response;

        // Service Ä‘Ã£ tá»± lÆ°u token vÃ  user
        // Chá»‰ cáº§n cáº­p nháº­t state
        setAuthState(createAuthenticatedState(user));

        // Chuyá»ƒn hÆ°á»›ng Ä‘áº¿n trang chá»§ (hoáº·c dashboard)
        setTimeout(() => {
          window.location.href = '/user/dashboard'; // Hoáº·c '/'
        }, 100);
      } else {
        setAuthState(prev => ({ ...prev, isLoading: false }));
        const errorMessage = 'Registration failed';
        setError(errorMessage);
        throw new Error(errorMessage);
      }
    } catch (err) {
      const errorMessage = err instanceof Error ? err.message : 'Registration failed';
      setError(errorMessage);
      setAuthState(resetAuthState());
      throw err;
    }
  };

  // ... (Giá»¯ nguyÃªn cÃ¡c hÃ m cÃ²n láº¡i) ...
}

// ... (Giá»¯ nguyÃªn useAuth) ...
BÆ°á»›c 2: Cáº­p nháº­t UI (File: src/app/auth/register/page.tsx)Trang Ä‘Äƒng kÃ½ cá»§a báº¡n Ä‘ang tá»± xá»­ lÃ½ logic mock. Báº¡n cáº§n cáº­p nháº­t nÃ³ Ä‘á»ƒ gá»i hÃ m register tá»« useAuth().Code cÅ© (Ä‘ang dÃ¹ng mock):TypeScript// src/app/auth/register/page.tsx (CÅ¨)
// ...
  const handleSubmit = async (e: React.FormEvent) => {
    // ... (validateForm) ...
    setIsLoading(true);
    // ...
    try {
      // Mock API call - Bá» ÄI
      await new Promise((resolve) => setTimeout(resolve, 2000));
      localStorage.setItem('auth_token', 'mock-jwt-token');
      localStorage.setItem('user_role', 'user');
      // ...
      router.push('/user/dashboard');
    } // ...
  };
// ...
Code má»›i (sá»­ dá»¥ng useAuth):TypeScript// src/app/auth/register/page.tsx (Má»šI)
// ...
import { useAuth } from '@/lib/auth'; // 1. Import useAuth
import { RegisterCredentials } from '@/services/auth.service'; // 2. Import RegisterCredentials

export default function RegisterPage() {
  const { t } = useLanguage();
  const { register, isLoading, error: authError } = useAuth(); // 3. Láº¥y hÃ m register tá»« context
  const [formData, setFormData] = useState({
    firstName: '',
    lastName: '',
    email: '',
    password: '',
    confirmPassword: '',
    // 'sex' khÃ´ng Ä‘Æ°á»£c dÃ¹ng trong auth.service.ts, nhÆ°ng backend cÃ³
    // Táº¡m thá»i bá» qua 'sex' Ä‘á»ƒ khá»›p vá»›i auth.service.ts
  });
  // ... (Giá»¯ nguyÃªn cÃ¡c state khÃ¡c: showPassword, agreeToTerms, errors)
  const router = useRouter();

  // ... (Giá»¯ nguyÃªn hÃ m validateForm, nhÆ°ng XÃ“A validate cho 'role') ...
  // ... (Giá»¯ nguyÃªn hÃ m handleInputChange) ...

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!validateForm()) {
      toast.error('ThÃ´ng tin khÃ´ng há»£p lá»‡', {
        description: 'Vui lÃ²ng kiá»ƒm tra láº¡i cÃ¡c trÆ°á»ng thÃ´ng tin',
      });
      return;
    }

    // 4. Gá»i hÃ m register tá»« context
    try {
      const credentials: RegisterCredentials = {
        firstName: formData.firstName,
        lastName: formData.lastName,
        email: formData.email,
        password: formData.password,
      };

      await register(credentials);
      
      // KhÃ´ng cáº§n lÃ m gÃ¬ thÃªm, AuthProvider sáº½ tá»± Ä‘á»™ng
      // cáº­p nháº­t state vÃ  chuyá»ƒn hÆ°á»›ng
      
    } catch (error: any) {
      // Lá»—i Ä‘Ã£ Ä‘Æ°á»£c xá»­ lÃ½ trong AuthProvider vÃ  hiá»ƒn thá»‹ toast
      // Chá»‰ cáº§n cáº­p nháº­t state lá»—i cá»¥c bá»™ náº¿u muá»‘n
      setErrors({ submit: error.message || t('register.errors.submitFailed') });
      toast.error('ÄÄƒng kÃ½ tháº¥t báº¡i', {
        description: error.message || t('register.errors.submitFailed'),
      });
    }
    // AuthProvider Ä‘Ã£ xá»­ lÃ½ isLoading, khÃ´ng cáº§n setIsLoading(false) á»Ÿ Ä‘Ã¢y
  };

  return (
    // ... (Pháº§n JSX giá»¯ nguyÃªn) ...
    // Nhá»› cáº­p nháº­t state lá»—i náº¿u cÃ³
    // VÃ­ dá»¥: hiá»ƒn thá»‹ authError hoáº·c errors.submit
    <form onSubmit={handleSubmit} className="space-y-4">
      {(errors.submit || authError) && (
        <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
          {errors.submit || authError}
        </div>
      )}
    {/* ... (CÃ¡c trÆ°á»ng input cÃ²n láº¡i) ... */}
    {/* NÃºt submit bÃ¢y giá» sáº½ dÃ¹ng isLoading tá»« useAuth() */}
     <Button
        type="submit"
        className="w-full"
        loading={isLoading} // 5. DÃ¹ng isLoading tá»« useAuth
        disabled={isLoading}
      >
        {isLoading ? t('register.creating') : t('register.button')}
        {!isLoading && <ArrowRight className="ml-2 h-4 w-4" />}
      </Button>
    {/* ... (Pháº§n JSX cÃ²n láº¡i) ... */}
    </form>
  );
}
3. ğŸ“ Tá»•ng káº¿t Endpoint vÃ  FileLuá»“ngComponent Giao diá»‡n (UI)Context (Quáº£n lÃ½ State)Service (Gá»i API)Endpoint (Nginx)Backend (Controller)ÄÄƒng nháº­plogin/page.tsxlib/auth.tsauth.service.tsPOST /api/auth/signinAuthController.javaLáº¥y User(Sau khi login)lib/auth.tsauth.service.tsGET /api/auth/meAuthController.javaÄÄƒng kÃ½register/page.tsxlib/auth.tsauth.service.tsPOST /api/auth/signup